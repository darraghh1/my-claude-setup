<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 950 780" font-family="Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#6b7280"/>
    </marker>
    <marker id="arrow-fail" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#ef4444"/>
    </marker>
    <marker id="arrow-pass" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#22c55e"/>
    </marker>
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.08"/>
    </filter>
    <linearGradient id="planGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#eff6ff"/>
      <stop offset="100%" stop-color="#dbeafe"/>
    </linearGradient>
    <linearGradient id="buildGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#faf5ff"/>
      <stop offset="100%" stop-color="#f3e8ff"/>
    </linearGradient>
    <linearGradient id="validateGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#f0fdf4"/>
      <stop offset="100%" stop-color="#dcfce7"/>
    </linearGradient>
  </defs>

  <style>
    .title { font-size: 11px; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; }
    .node-text { font-size: 13px; font-weight: 500; }
    .node-sub { font-size: 11px; fill: #6b7280; }
    .label { font-size: 11px; font-weight: 600; }
    .label-pass { fill: #16a34a; }
    .label-fail { fill: #dc2626; }
    .label-fix { fill: #d97706; }
    .slash { font-size: 13px; font-weight: 700; font-family: 'JetBrains Mono', 'Fira Code', monospace; }
  </style>

  <!-- ═══ PLANNING PHASE (user-driven) ═══ -->
  <g>
    <rect x="30" y="20" width="260" height="240" rx="12" fill="url(#planGrad)" stroke="#93c5fd" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="160" y="46" text-anchor="middle" class="title" fill="#1d4ed8">Planning</text>

    <!-- /create-plan -->
    <rect x="70" y="64" width="180" height="40" rx="8" fill="#fff" stroke="#3b82f6" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="160" y="88" text-anchor="middle" class="slash" fill="#2563eb">/create-plan</text>

    <line x1="160" y1="104" x2="160" y2="124" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

    <!-- /review-plan -->
    <rect x="70" y="126" width="180" height="40" rx="8" fill="#fff" stroke="#3b82f6" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="160" y="150" text-anchor="middle" class="slash" fill="#2563eb">/review-plan</text>

    <line x1="160" y1="166" x2="160" y2="186" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

    <!-- Decision: review passes? -->
    <polygon points="160,188 215,213 160,238 105,213" fill="#fff" stroke="#3b82f6" stroke-width="1.5"/>
    <text x="160" y="216" text-anchor="middle" class="node-text" fill="#1e40af" font-size="11">Passes?</text>

    <!-- Yes → down -->
    <line x1="160" y1="238" x2="160" y2="252" stroke="#22c55e" stroke-width="1.5" marker-end="url(#arrow-pass)"/>
    <text x="170" y="250" class="label label-pass">Yes</text>

    <!-- No → left, loops back up to /review-plan -->
    <line x1="105" y1="213" x2="56" y2="213" stroke="#ef4444" stroke-width="1.5"/>
    <line x1="56" y1="213" x2="56" y2="146" stroke="#ef4444" stroke-width="1.5"/>
    <line x1="56" y1="146" x2="68" y2="146" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arrow-fail)"/>
    <text x="44" y="183" class="label label-fix" transform="rotate(-90 44 183)">Fix</text>
  </g>

  <!-- ═══ Arrow from planning to /implement ═══ -->
  <path d="M 160 254 L 160 280 L 315 280 L 315 79 L 398 79" fill="none" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- ═══ IMPLEMENTATION PHASE ═══ -->
  <g>
    <rect x="342" y="20" width="585" height="740" rx="12" fill="#fafafa" stroke="#d1d5db" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="634" y="46" text-anchor="middle" class="title" fill="#374151">/implement — Orchestrator Loop</text>

    <!-- /audit-plan (auto-called by /implement for 3+ phases) -->
    <rect x="400" y="60" width="200" height="38" rx="8" fill="#fff" stroke="#3b82f6" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="500" y="78" text-anchor="middle" class="slash" fill="#2563eb" font-size="12">/audit-plan</text>
    <text x="500" y="91" text-anchor="middle" class="node-sub">auto-run for 3+ phases</text>

    <!-- Arrow down -->
    <line x1="500" y1="98" x2="500" y2="114" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

    <!-- Audit gate checks annotation -->
    <rect x="630" y="56" width="175" height="58" rx="6" fill="#fefce8" stroke="#eab308" stroke-width="1" filter="url(#shadow)"/>
    <text x="718" y="74" text-anchor="middle" class="title" fill="#a16207" font-size="10">Audit Gate</text>
    <text x="718" y="89" text-anchor="middle" class="node-sub" font-size="10">Major issues → STOP</text>
    <text x="718" y="102" text-anchor="middle" class="node-sub" font-size="10">Minor issues → proceed</text>

    <!-- Dashed line from audit to annotation -->
    <line x1="600" y1="79" x2="628" y2="79" stroke="#eab308" stroke-width="1" stroke-dasharray="4 3"/>

    <!-- Next pending phase -->
    <rect x="400" y="116" width="200" height="38" rx="8" fill="#fff" stroke="#6b7280" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="500" y="134" text-anchor="middle" class="node-text" fill="#374151">Next pending phase</text>
    <text x="500" y="147" text-anchor="middle" class="node-sub">from plan.md phase table</text>

    <!-- Arrow down to "All done?" -->
    <line x1="500" y1="154" x2="500" y2="170" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

    <!-- "All done?" diamond -->
    <polygon points="500,172 558,192 500,212 442,192" fill="#fff" stroke="#6b7280" stroke-width="1.5"/>
    <text x="500" y="196" text-anchor="middle" class="node-text" fill="#374151" font-size="10">All done?</text>

    <!-- Yes → right to "All done" pill -->
    <line x1="558" y1="192" x2="614" y2="192" stroke="#22c55e" stroke-width="1.5" marker-end="url(#arrow-pass)"/>
    <text x="576" y="185" class="label label-pass" font-size="10">Yes</text>

    <rect x="616" y="176" width="140" height="32" rx="16" fill="#dcfce7" stroke="#16a34a" stroke-width="2" filter="url(#shadow)"/>
    <text x="686" y="194" text-anchor="middle" class="node-text" fill="#15803d" font-weight="700">All done</text>
    <text x="686" y="205" text-anchor="middle" class="node-sub" font-size="9">shutdown team</text>

    <!-- No → down to phase gate -->
    <line x1="500" y1="212" x2="500" y2="228" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>
    <text x="512" y="224" class="node-sub" font-size="10">No</text>

    <!-- Phase gate diamond -->
    <polygon points="500,230 562,252 500,274 438,252" fill="#fff" stroke="#6b7280" stroke-width="1.5"/>
    <text x="500" y="256" text-anchor="middle" class="node-text" fill="#374151" font-size="11">Phase gate</text>

    <!-- Gate checks annotation -->
    <rect x="620" y="230" width="175" height="58" rx="6" fill="#fefce8" stroke="#eab308" stroke-width="1" filter="url(#shadow)"/>
    <text x="708" y="248" text-anchor="middle" class="title" fill="#a16207" font-size="10">Gate Checks</text>
    <text x="708" y="263" text-anchor="middle" class="node-sub" font-size="10">No placeholder content</text>
    <text x="708" y="276" text-anchor="middle" class="node-sub" font-size="10">Phase review passes</text>

    <!-- Dashed line from diamond to gate checks -->
    <line x1="562" y1="252" x2="618" y2="252" stroke="#eab308" stroke-width="1" stroke-dasharray="4 3"/>

    <!-- Arrow down from gate -->
    <line x1="500" y1="274" x2="500" y2="292" stroke="#22c55e" stroke-width="1.5" marker-end="url(#arrow-pass)"/>

    <!-- ═══ BUILDER SUBGROUP ═══ -->
    <rect x="388" y="294" width="290" height="210" rx="10" fill="url(#buildGrad)" stroke="#a78bfa" stroke-width="1.5" stroke-dasharray="6 3"/>
    <text x="533" y="314" text-anchor="middle" class="title" fill="#7c3aed">Builder (ephemeral, per phase)</text>

    <!-- Find references -->
    <rect x="412" y="324" width="242" height="34" rx="6" fill="#fff" stroke="#8b5cf6" stroke-width="1" filter="url(#shadow)"/>
    <text x="533" y="345" text-anchor="middle" class="node-text" fill="#5b21b6">Find reference + domain skill</text>

    <line x1="533" y1="358" x2="533" y2="374" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

    <!-- TDD + implement -->
    <rect x="412" y="376" width="242" height="34" rx="6" fill="#fff" stroke="#8b5cf6" stroke-width="1" filter="url(#shadow)"/>
    <text x="533" y="397" text-anchor="middle" class="node-text" fill="#5b21b6">TDD first, then implement</text>

    <line x1="533" y1="410" x2="533" y2="426" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

    <!-- Code review -->
    <rect x="412" y="428" width="242" height="34" rx="6" fill="#fff" stroke="#8b5cf6" stroke-width="1" filter="url(#shadow)"/>
    <text x="533" y="449" text-anchor="middle" class="slash" fill="#7c3aed" font-size="12">/code-review + auto-fix</text>

    <!-- ═══ Quality Hooks annotation ═══ -->
    <rect x="700" y="326" width="175" height="74" rx="6" fill="#fefce8" stroke="#eab308" stroke-width="1" filter="url(#shadow)"/>
    <text x="788" y="346" text-anchor="middle" class="title" fill="#a16207" font-size="10">Quality Hooks</text>
    <text x="788" y="361" text-anchor="middle" class="node-sub" font-size="10">PostToolUse: TS checks</text>
    <text x="788" y="374" text-anchor="middle" class="node-sub" font-size="10">pnpm test + typecheck</text>
    <text x="788" y="387" text-anchor="middle" class="node-sub" font-size="10">Codebase-grounded review</text>

    <!-- Dashed line from builder to hooks -->
    <line x1="654" y1="363" x2="698" y2="363" stroke="#eab308" stroke-width="1" stroke-dasharray="4 3"/>

    <!-- Arrow from builder to validator -->
    <line x1="533" y1="504" x2="533" y2="524" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

    <!-- ═══ VALIDATOR SUBGROUP ═══ -->
    <rect x="388" y="526" width="290" height="78" rx="10" fill="url(#validateGrad)" stroke="#4ade80" stroke-width="1.5" stroke-dasharray="6 3"/>
    <text x="533" y="546" text-anchor="middle" class="title" fill="#15803d">Validator (persistent)</text>

    <rect x="412" y="556" width="242" height="34" rx="6" fill="#fff" stroke="#22c55e" stroke-width="1" filter="url(#shadow)"/>
    <text x="533" y="577" text-anchor="middle" class="node-text" fill="#166534">Files, patterns, tests, typecheck</text>

    <!-- Arrow from validator to result -->
    <line x1="533" y1="604" x2="533" y2="624" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrow)"/>

    <!-- ═══ Verdict diamond ═══ -->
    <polygon points="533,626 593,651 533,676 473,651" fill="#fff" stroke="#6b7280" stroke-width="1.5"/>
    <text x="533" y="655" text-anchor="middle" class="node-text" fill="#374151" font-size="12">Result</text>

    <!-- PASS → right to "Phase done" -->
    <line x1="593" y1="651" x2="658" y2="651" stroke="#22c55e" stroke-width="1.5" marker-end="url(#arrow-pass)"/>
    <text x="620" y="644" class="label label-pass">PASS</text>

    <!-- Phase done box -->
    <rect x="660" y="635" width="130" height="32" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="725" y="655" text-anchor="middle" class="node-text" fill="#166534">Phase done</text>

    <!-- ═══ Green loop: Phase done → right → up → left into right side of "Next pending phase" ═══ -->
    <line x1="790" y1="651" x2="905" y2="651" stroke="#22c55e" stroke-width="1.5"/>
    <line x1="905" y1="651" x2="905" y2="135" stroke="#22c55e" stroke-width="1.5"/>
    <line x1="905" y1="135" x2="602" y2="135" stroke="#22c55e" stroke-width="1.5" marker-end="url(#arrow-pass)"/>
    <text x="913" y="405" class="label label-pass" transform="rotate(-90 913 405)">Next phase</text>

    <!-- ═══ FAIL → left, outside builder/validator boxes ═══ -->
    <line x1="473" y1="651" x2="365" y2="651" stroke="#ef4444" stroke-width="1.5"/>
    <text x="418" y="644" class="label label-fail">FAIL</text>

    <!-- Red loop: left of boxes → up → into builder "Find reference" -->
    <line x1="365" y1="651" x2="365" y2="341" stroke="#ef4444" stroke-width="1.5"/>
    <line x1="365" y1="341" x2="410" y2="341" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arrow-fail)"/>
    <text x="355" y="506" class="label label-fail" transform="rotate(-90 355 506)">Fresh builder</text>
  </g>
</svg>